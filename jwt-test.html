<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>E2E SSO Dashboard - Self-Embedding</title>
  <style>
    :root {
      --primary: #2563eb; --bg: #0f172a; --card-bg: #1e293b;
      --text: #f8fafc; --accent: #38bdf8; --error: #f87171;
      --success: #10b981; --warning: #fbbf24; --info: #6366f1;
    }
    body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); color: var(--text); font-family: 'Inter', system-ui, sans-serif; overflow: hidden; }

    /* Parent View Styles */
    #parent-view { display: flex; flex-direction: column; height: 100vh; }
    .header { padding: 12px 20px; background: #1e293b; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; }
    .status-pill { font-size: 11px; padding: 4px 10px; border-radius: 12px; background: rgba(56, 189, 248, 0.1); color: var(--accent); border: 1px solid var(--accent); font-weight: bold; }
    iframe { flex-grow: 1; width: 100%; background: #f1f5f9; border: 6px dashed var(--warning); box-shadow: 0 0 15px rgba(251, 191, 36, 0.4); box-sizing: border-box; }

    /* SSO Dashboard Styles */
    #sso-view { padding: 40px; height: 100vh; overflow-y: auto; box-sizing: border-box; display: none; }
    .dashboard { max-width: 1600px; margin: auto; display: grid; grid-template-columns: 480px 1fr; gap: 30px; }
    .panel { background: var(--card-bg); padding: 30px; border-radius: 12px; border: 1px solid #334155; box-shadow: 0 10px 25px rgba(0,0,0,0.3); height: fit-content; }
    h2 { margin-top: 0; font-size: 1.6rem; color: var(--accent); }
    .field { margin-bottom: 25px; }
    label { display: block; margin-bottom: 8px; font-size: 11px; font-weight: 700; text-transform: uppercase; color: #94a3b8; letter-spacing: 0.1em; }
    textarea { width: 100%; height: 200px; background: #000; color: #38bdf8; border: 1px solid #334155; border-radius: 8px; padding: 15px; font-family: 'Fira Code', monospace; font-size: 12px; resize: none; margin-bottom: 10px; box-sizing: border-box; }
    select, button { width: 100%; padding: 14px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: white; font-size: 15px; box-sizing: border-box; }
    .btn-primary { background: var(--primary); border: none; font-weight: bold; cursor: pointer; transition: all 0.2s; margin-top: 10px; text-transform: uppercase; }
    .btn-primary:hover { background: #1d4ed8; transform: translateY(-1px); }
    .btn-util { background: transparent; border: 1px solid #334155; color: var(--warning); font-size: 11px; padding: 8px; cursor: pointer; text-decoration: none; text-align: center; border-radius: 6px; flex: 1; transition: all 0.2s; }
    .utility-row { display: flex; gap: 10px; margin-top: 5px; }
    .debug-view { display: flex; flex-direction: column; gap: 20px; min-width: 0; }
    .url-display { background: #1e293b; padding: 20px; border-radius: 8px; font-family: 'Fira Code', monospace; font-size: 13px; border: 1px solid #334155; color: #94a3b8; }
    .url-display span { color: var(--accent); font-weight: bold; }
    .console { background: #000; border-radius: 8px; padding: 25px; font-family: 'Fira Code', monospace; font-size: 13px; flex-grow: 1; min-height: 500px; overflow-y: auto; border: 1px solid #334155; line-height: 1.6; }
    .log-line { margin-bottom: 15px; border-left: 3px solid #334155; padding-left: 20px; }
    .log-msg.SUCCESS { color: var(--success); font-weight: bold; }
    .log-msg.ERROR { color: var(--error); font-weight: bold; }
    .hint-box { margin-top: 10px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 6px; font-size: 12px; color: #94a3b8; }
    .header-badge { display: inline-block; margin-top: 8px; font-size: 11px; color: var(--info); font-family: 'Fira Code', monospace; }
  </style>
</head>
<body>

<div id="parent-view">
  <div class="header">
    <div style="font-weight: bold; color: var(--accent)">E2E SSO DEBUGGER <span style="color: #475569; font-weight: normal; margin-left: 8px;">(Shell)</span></div>
    <div id="path-indicator" class="status-pill">--</div>
  </div>
  <iframe id="main-iframe"></iframe>
</div>

<div id="sso-view">
  <div class="dashboard">
    <div class="panel">
      <h2>SSO Token Injector</h2>
      <form id="authForm">
        <div class="field">
          <label>Target Environment</label>
          <select id="envSelector" onchange="updateUrls()">
            <option value="https://local.ecosio.com/monitor">Local Development</option>
            <option value="https://app.dev.ecosio.com/monitor">Dev Environment</option>
          </select>
        </div>
        <div class="field">
          <label>JWT Token</label>
          <textarea id="jwtToken" placeholder="Paste full JWT string here..." required></textarea>
          <div class="utility-row">
            <button type="button" class="btn-util" id="btnCopyInspect">Copy & Inspect on JWT.io</button>
          </div>
        </div>
        <button type="submit" class="btn-primary">Authenticate Iframe</button>
      </form>
    </div>

    <div class="debug-view">
      <div class="url-display">
        <div><b>API TARGET:</b> [POST] <span id="targetPostUrl">--</span></div>
      </div>
      <div class="console" id="console">
        <div class="log-line">> Iframe context initialized. Awaiting JWT.</div>
      </div>
    </div>
  </div>
</div>

<script>
  (function router() {
    const isSsoView = window.location.hash === '#sso';

    if (isSsoView) {
      const parentEl = document.getElementById('parent-view');
      if (parentEl) parentEl.remove();
      document.getElementById('sso-view').style.display = 'block';
      initDashboard();
    } else {
      const ssoEl = document.getElementById('sso-view');
      if (ssoEl) ssoEl.remove();
      document.getElementById('parent-view').style.display = 'flex';
      const iframeSrc = window.location.href.split('#')[0] + '#sso';
      const indicator = document.getElementById('path-indicator');
      indicator.textContent = `IFRAME SRC: ${window.location.pathname}#sso`;
      document.getElementById('main-iframe').src = iframeSrc;

      window.addEventListener('message', (event) => {
        const allowedOrigins = [
          window.location.origin,
          'https://static.vrx.com',
          'https://static.ecosio.com',
          'https://local.ecosio.com',
          'https://app.dev.ecosio.com'
        ];

        if (!allowedOrigins.includes(event.origin)) {
          console.warn('Blocked message from untrusted origin:', event.origin);
          return;
        }

        const payload = event.data;

        // Check if this is the specific auth error from monitors Axios interceptor
        if (payload && payload.type === 'ECOSIO_APP_AUTH_ERROR') {
          console.error('Parent caught iframe error:', payload);

          // Update the top right status pill to show the error securely
          indicator.textContent = `AUTH ERROR: ${payload.details} | ID: ${payload.uniqueId || 'N/A'}`;
          indicator.style.backgroundColor = 'rgba(248, 113, 113, 0.1)';
          indicator.style.color = '#f87171';
          indicator.style.borderColor = '#f87171';

          alert(`Iframe Authorization Error Caught!\n\nDetails: ${payload.details}\nUnique ID: ${payload.uniqueId}`);
        }
      });
    }
  })();

  function initDashboard() {
    const logger = document.getElementById('console');
    const envSelector = document.getElementById('envSelector');
    const tokenArea = document.getElementById('jwtToken');

    const hostname = window.location.hostname;
    if (hostname === 'app.dev.ecosio.com') {
      envSelector.value = "https://app.dev.ecosio.com/monitor";
    } else {
      envSelector.value = "https://local.ecosio.com/monitor";
    }

    window.updateUrls = function() {
      document.getElementById('targetPostUrl').textContent = `${envSelector.value}/api/vertex/sso`;
    };

    /**
     * Enhanced Logger to display Response Headers safely
     */
    function log(msg, type = 'INFO', hint = '', uniqueId = '') {
      // Building elements using document.createElement and textContent
      const line = document.createElement('div');
      line.className = 'log-line';

      // 1. Timestamp
      const timeSpan = document.createElement('span');
      timeSpan.style.color = '#475569';
      timeSpan.style.fontSize = '11px';
      timeSpan.style.marginRight = '12px';
      timeSpan.textContent = new Date().toLocaleTimeString();
      line.appendChild(timeSpan);

      // 2. Message Body
      const msgSpan = document.createElement('span');
      msgSpan.className = `log-msg ${type}`;
      msgSpan.textContent = msg; // textContent automatically escapes HTML
      line.appendChild(msgSpan);

      // 3. Unique ID Badge
      if (uniqueId) {
        const headerBadge = document.createElement('div');
        headerBadge.className = 'header-badge';

        const boldText = document.createElement('b');
        boldText.textContent = 'X-UNIQUE-ID: ';
        headerBadge.appendChild(boldText);

        const idSpan = document.createElement('span');
        idSpan.textContent = uniqueId;
        headerBadge.appendChild(idSpan);

        line.appendChild(headerBadge);
      }

      // 4. Hint Box
      if (hint) {
        const hintBox = document.createElement('div');
        hintBox.className = 'hint-box';
        hintBox.textContent = hint;
        line.appendChild(hintBox);
      }

      logger.appendChild(line);
      logger.scrollTop = logger.scrollHeight;
    }

    document.getElementById('btnCopyInspect').addEventListener('click', () => {
      const token = tokenArea.value.trim();
      if (!token) { log("No token!", "ERROR"); return; }
      navigator.clipboard.writeText(token).then(() => {
        log("Token copied. Opening JWT.io...", "SUCCESS");
        window.open('https://jwt.io/', '_blank');
      });
    });

    document.getElementById('authForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const base = envSelector.value;
      const token = tokenArea.value.trim();
      const fullUrl = `${base}/api/vertex/sso`;

      log(`Initiating SSO POST inside iframe...`);

      try {
        const resp = await fetch(fullUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ token: token })
        });

        // Extract Response Header
        const xUniqueId = resp.headers.get('x-unique-id');

        if (resp.ok) {
          log(`HTTP SUCCESS: Session injected.`, 'SUCCESS', '', xUniqueId);

          const isLocal = base.includes('local.ecosio.com');
          const redirectBase = isLocal ? 'https://local.ecosio.com/monitor' : 'https://app.dev.ecosio.com/monitor';

          log(`Redirecting iframe to: ${redirectBase}/messages?noLayout=true`, 'INFO');

          setTimeout(() => {
            window.location.href = `${redirectBase}/messages?noLayout=true`;
          }, 1000);
        } else {
          log(`REJECTED: ${resp.status}`, 'ERROR', `Check if your JWT secret matches the target environment.`, xUniqueId);
        }
      } catch (err) {
        log(`NETWORK ERROR`, 'ERROR', `Verify the backend is running and CORS is allowed for this origin.`);
      }
    });

    updateUrls();
  }
</script>

</body>
</html>
